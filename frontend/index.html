<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <link rel="stylesheet" href="/frontend/PhotoSwipe/photoswipe.css">
    <link rel="stylesheet"
        href="/frontend/PhotoSwipe/photoswipe-dynamic-caption-plugin/photoswipe-dynamic-caption-plugin.css">
    <script src="/frontend/jquery-3.6.0.min.js"></script>
    <script src="/frontend/pica.min.js"></script>

</head>

<body>

    <script type="module">
        import PhotoSwipeLightbox from '/frontend/PhotoSwipe/photoswipe-lightbox.esm.js';
        import PhotoSwipeDynamicCaption from '/frontend/PhotoSwipe/photoswipe-dynamic-caption-plugin/photoswipe-dynamic-caption-plugin.esm.js';

        const lightbox = new PhotoSwipeLightbox({
            gallery: '#gallery',
            children: 'a',
            showHideAnimationType: 'zoom',
            bgOpacity: 0.95,
            loop: false,
            wheelToZoom: true,
            clickToCloseNonZoomable: false,
            pswpModule: () => import('/frontend/PhotoSwipe/photoswipe.esm.js'),
        });

        const captionPlugin = new PhotoSwipeDynamicCaption(lightbox, {
            type: 'aside',
        });

        lightbox.init();
    </script>

    <br>
    <span onclick="onClickHandler()" style="background-color: green; color: white; padding: 10px; user-select: none;">
        click here to load
    </span>
    <br><br>
    <hr>

    <div class="pswp-gallery docs-styled-scrollbar" id="gallery"
        style="align-items: flex-start;display: flex;flex-direction: row;flex-wrap: wrap;">
    </div>




    <style>
        a img {
            max-height: 224px;
        }

        a {
            margin: 5px;
        }

        a:hover {
            -webkit-filter: brightness(85%);
            filter: brightness(85%);
            -webkit-transition: all 100ms ease;
            -moz-transition: all 100ms ease;
            -o-transition: all 100ms ease;
            -ms-transition: all 100ms ease;
            transition: all 100ms ease;
        }
    </style>


    <script>

        async function onClickHandler(event) {
            try {
                const _pica = new pica();
                const directoryHandle = await window.showDirectoryPicker()
                const files = await listAllFilesAndDirs(directoryHandle);
                // console.log('files', files);

                for (const file of files) {
                    const handle = await file.handle.getFile();
                    // console.log(handle);

                    getHeightAndWidthFromDataUrl(URL.createObjectURL(handle))
                        .then((imageSize) => {
                            handle.text()
                                .then((text) => {
                                    let XMP = readXMPData(getXMPString(text));
                                    // console.log(JSON.stringify(XMP, null, 2));

                                    const url = URL.createObjectURL(handle);
                                    const a = document.createElement('a');
                                    a.href = url;
                                    a.setAttribute('target', '_blank');
                                    a.setAttribute('data-pswp-width', imageSize.width);
                                    a.setAttribute('data-pswp-height', imageSize.height);
                                    a.setAttribute('data-tweetid', XMP.AOSource);
                                    const img = document.createElement("img");

                                    const _thumbnail = new Image(imageSize.width, imageSize.height);
                                    _thumbnail.src = url;
                                    const canvas = document.createElement('canvas');
                                    canvas.width = imageSize.width;
                                    canvas.height = imageSize.height;
                                    
                                    _pica.resize(_thumbnail, canvas)
                                    .then(result => _pica.toBlob(result, 'image/jpeg', 0.90))
                                    .then(blob => {
                                        img.src = URL.createObjectURL(blob);
                                    });

                                    // img.src = url;

                                    const caption = document.createElement('span');
                                    caption.className = 'pswp-caption-content';
                                    caption.innerHTML = "";
                                    caption.innerHTML += `<b>${XMP.AOCreator}</b> ${XMP.AOCreatorId}<br>`;
                                    caption.innerHTML += `<span style="color: grey">${XMP.AODateCreated.toLocaleString()}</span><br><br>`;
                                    caption.innerHTML += XMP.AOContentDescription + "<br><br>";
                                    caption.innerHTML += `<span style="color: grey">Resource order No.: ${XMP.AOSourceInvNo}</span><br>`;
                                    caption.innerHTML += `<span style="color: grey; text-decoration: underline; cursor: pointer;" onclick="window.open('https://twitter.com/${XMP.AOCreatorId}/status/${XMP.AOSource}', '_blank')">Tweet ID: ${XMP.AOSource}</span><br>`;
                                    if (XMP.StorylineIdentifier != "none") {
                                        caption.innerHTML += `<span style="color: grey">Referenced tweet ID: ${XMP.StorylineIdentifier}</span><br>`;
                                    }
                                    if (XMP.Genre.length > 0) {
                                        caption.innerHTML += `<span style="color: grey">Tags: ${XMP.Genre.join(", ")}</span><br>`;
                                    }

                                    a.appendChild(img);
                                    a.appendChild(caption);
                                    document.getElementById("gallery").appendChild(a);

                                    var $wrapper = $('#gallery');

                                    $wrapper.find('a').sort(function (a, b) {
                                        return +a.dataset.tweetid - +b.dataset.tweetid;
                                    })
                                        .appendTo($wrapper);
                                });
                        })
                }
            } catch (e) {
                console.log(e);
            }
        }

        async function getHeightAndWidthFromDataUrl(dataURL) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve({ width: img.width, height: img.height });
                img.onerror = reject;
                img.src = dataURL;
            });
        }

        async function listAllFilesAndDirs(dirHandle) {
            const files = [];
            for await (let [name, handle] of dirHandle) {
                // console.log(handle);
                const { kind } = handle;
                if (handle.kind === 'directory') {
                    // files.push({ name, handle, kind });
                    files.push(...await listAllFilesAndDirs(handle));
                } else {
                    files.push({ name, handle, kind });
                }
            }
            return files;
        }

        function getXMPString(string) {
            return string.substring(string.indexOf("<x:xmpmeta"), string.indexOf("</x:xmpmeta>") + 12);
        }

        function readXMPData(xmpString) {

            const parser = new DOMParser();
            xmp = parser.parseFromString(xmpString, 'application/xml');

            return {
                AOContentDescription: xmp.getElementsByTagName("Iptc4xmpExt:AOContentDescription")[0].textContent.trim(),
                AOCreator: xmp.getElementsByTagName("Iptc4xmpExt:AOCreator")[0].textContent.trim(),
                AOCreatorId: xmp.getElementsByTagName("Iptc4xmpExt:AOCreatorId")[0].textContent.trim(),
                AODateCreated: new Date(xmp.getElementsByTagName("Iptc4xmpExt:AODateCreated")[0].textContent.trim()),
                AOSource: xmp.getElementsByTagName("Iptc4xmpExt:AOSource")[0].textContent.trim(),
                AOSourceInvNo: xmp.getElementsByTagName("Iptc4xmpExt:AOSourceInvNo")[0].textContent.trim(),
                StorylineIdentifier:
                    xmp.getElementsByTagName("Iptc4xmpExt:StorylineIdentifier").length > 0
                        ? xmp.getElementsByTagName("Iptc4xmpExt:StorylineIdentifier")[0].textContent.trim()
                        : "none",
                Genre: xmp.getElementsByTagName("Iptc4xmpExt:Genre").length > 0
                    ? xmp.getElementsByTagName("Iptc4xmpExt:Genre")[0].textContent.trim().split("<br>")
                    : [],
            };
        }

    </script>

</body>

</html>